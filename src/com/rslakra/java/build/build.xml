<?xml version="1.0" encoding="UTF-8"?>

<!--
Created By : Rohtash Singh (rohtash.singh@gmail.com)
Version    : 1.0
Created On : 2009/04/20

This file can be edited as per the requirements but
permissions are required to make any changes.

The various targets defined below can be used for execution of the tasks.
The basic information and purposes of the targets are given below:

-->

<!--  Created By: Rohtash Singh -->
<project name="Java" default="all" basedir=".">
	<!-- Common Properties -->
	<property file="${basedir}/build.properties"/>
	<property name="src.dir" value="${basedir}/src"/>
	<property name="build.dir" value="${basedir}/build"/>
	<property name="classes.dir" value="${build.dir}/classes"/>
	<property name="libs.dir" value="Libs"/>
	<property name="jar.file" value="${ant.project.name}.jar"/>

	<!-- class path -->
	<path id="third.party.jars">
		<fileset dir="${basedir}/${libs.dir}" includes="**/*.jar"/>
	</path>

	<target name="all" depends="clean, build, end"/>

	<!-- Clean"'s purpose is to delete the contents of the build directory -->
	<target name="clean" depends="start" description="Cleans the build dir's">
		<delete dir="${build.dir}" quiet="true"/>
	 	<delete dir="${deploy.dir}" quiet="true" />
	</target>

	<!-- Creates JAR file -->
	<target name="build" depends="compile">
		<!-- Create jar file and place in base directory,
			which includes *.properties, *.xml, *.class and library files -->

		<mkdir dir="${deploy.dir}/${libs.dir}"/>
		<copy todir="${deploy.dir}/${libs.dir}">
			<fileset dir="${basedir}/${libs.dir}" includes="**/*" />
		</copy>

		<jar destfile="${deploy.dir}/${jar.file}">
			<fileset dir="${basedir}/" includes="*.properties" excludes="build.properties, build.xml"/>
			<fileset dir="${classes.dir}" includes="**/*.class" />
			<fileset dir="${deploy.dir}"/>

		    <manifest>
		        <attribute name="Built-By" value="Rohtash Singh"/>
				<attribute name="Implementation-Vendor" value="lakra.com"/>
		      	<attribute name="Implementation-Title" value="Utilities by Lakra Inc."/>
		    </manifest>
		</jar>

		<!-- Sign jar syntax:
		jarsigner -keystore <keystorefilename> -storepass <store-password> -keypass <key-password> -signedjar <signed-jarfile.jar> <unsigned.jarfile> openacircle
		jarsigner -keystore .keystore_Blideo_2008 -storepass 3nc0d3rk3y -keypass 0p3n2c1rcl3 -signedjar SOpenACircleAssistant.jar OpenACircleAssistant.jar openacircle
		-->
		<!-- signjar keystore="${src.dir}/Blideo_2008.keystore" storepass="3nc0d3rk3y" keypass="0p3n2c1rcl3" signedjar="${libs.dir}/S${jar.file}" jar="${libs.dir}/${jar.file}" alias="openacircle"/-->
	</target>

	<!-- Obfuscate code -->
	<target name="post-compile">
		<obfuscate>
     		<fileset dir="${classes.dir}"/>
     	</obfuscate>
	</target>

	<!-- Compilation -->
	<target name="compile" depends="init" description="Compiling .java files">
		<echo>Compiling '${src.dir}' into '${classes.dir}'</echo>
		<javac fork="${javac.fork}"
			srcdir="${src.dir}"
			destdir="${classes.dir}"
			source="${javac.source}"
			target="${javac.target}"
            optimize="${javac.optimize}"
            debug="${javac.debug}"
            debuglevel="${javac.debug.level}"
			listfiles="true"
			failonerror="true"
			includeantruntime="false"
			classpathref="third.party.jars" />
	</target>

	<target name="init" description="Makes the base dir structure">
		<mkdir dir="${build.dir}"/>
		<mkdir dir="${classes.dir}"/>
	    <mkdir dir="${deploy.dir}"/>
	</target>

	<target name="start" description="Start's Build Process">
		<!-- Create the Time Stamp -->
		<tstamp>
			<format property="TODAY" pattern="yyyy-MM-dd" />
			<format property="DSTAMP" pattern="yyyy-MM-dd HH:mm:ss Z (EEE, dd MMM yyyy)" />

			<format property="startDateTime" pattern="yyyy-MM-dd HH:mm:ss Z" />
		</tstamp>
		<echo />
		<echo>Build Process started at '${startDateTime}'</echo>
		<echo />
	</target>

	<target name="end" description="Start's Build Process">
		<!-- Create the Time Stamp -->
		<tstamp>
			<format property="TODAY" pattern="yyyy-MM-dd" />
			<format property="DSTAMP" pattern="yyyy-MM-dd HH:mm:ss Z (EEE, dd MMM yyyy)" />

			<format property="endDateTime" pattern="yyyy-MM-dd HH:mm:ss Z" />
		</tstamp>
		<echo />
		<echo>Build Process finished at '${endDateTime}'</echo>
		<echo />
	</target>

	<!-- Defining ant task for yGuard -->
	<property name="yGuard.classpath" value="${basedir}/${libs.dir}/yguard.jar"/>
	<taskdef name="yguard" classname="com.yworks.yguard.YGuardTask" classpath="${yGuard.classpath}"></taskdef>

	<target name="obfuscate">
      <yguard>
      	<inoutpair in="${deploy.dir}/${jar.file}" out="${deploy.dir}/obf_${jar.file}" />
      		<shrink logfile="shrinklog.xml">
      			<property name="error-checking" value="pedantic"/>
      			<keep>
        			<class classes="public"/>
      			</keep>
    		</shrink>
      </yguard>
    </target>

	<!-- Create Source Jar File in base directory -->
	<target name="source.jar">
		<echo message="Creating Source Jar file ..." />
		<delete file="${basedir}/src.jar"/>
		<jar jarfile="${basedir}/src.jar" basedir="${basedir}/src" manifest="${basedir}/src/META-INF/MANIFEST.MF" update="true" />
	</target>

</project>
